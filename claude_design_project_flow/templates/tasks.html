{% extends "base.html" %}
{% block title %}Tasks â€” Application Onboarding Portal{% endblock %}

{% block head %}
<style>
    .filter-chip { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.375rem 0.75rem;
                   border-radius: 9999px; font-size: 0.8125rem; font-weight: 500; cursor: pointer;
                   border: 1px solid #e2e8f0; color: #64748b; transition: all 0.15s; }
    .filter-chip:hover { border-color: #cbd5e1; color: #334155; }
    .filter-chip.active { background: #2563eb; border-color: #2563eb; color: white; }
    .task-card { transition: all 0.15s ease; }
    .task-card:hover { background: #f8fafc; }
</style>
{% endblock %}

{% block content %}
<div class="p-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-slate-900">Task Management</h1>
            {% if selected_project %}
            <p class="text-slate-500 text-sm mt-1">Showing tasks for <span class="font-semibold text-blue-600">{{ selected_project.project_name }}</span></p>
            {% else %}
            <p class="text-slate-500 text-sm mt-1">View and manage tasks across all projects</p>
            {% endif %}
        </div>
    </div>

    {% if selected_project %}
    <!-- Single Project Stats -->
    <div class="grid grid-cols-5 gap-4 mb-6">
        <div class="card text-center">
            <p class="text-2xl font-bold text-slate-900">{{ stats.total or 0 }}</p>
            <p class="text-xs text-slate-500 mt-1">Total Tasks</p>
        </div>
        <div class="card text-center">
            <p class="text-2xl font-bold text-green-600">{{ stats.completed or 0 }}</p>
            <p class="text-xs text-slate-500 mt-1">Completed</p>
        </div>
        <div class="card text-center">
            <p class="text-2xl font-bold text-blue-600">{{ stats.in_progress or 0 }}</p>
            <p class="text-xs text-slate-500 mt-1">In Progress</p>
        </div>
        <div class="card text-center">
            <p class="text-2xl font-bold text-slate-400">{{ stats.pending or 0 }}</p>
            <p class="text-xs text-slate-500 mt-1">Pending</p>
        </div>
        <div class="card text-center">
            <p class="text-2xl font-bold text-blue-700">{{ ((stats.completed / (stats.total or 1)) * 100)|round|int }}%</p>
            <p class="text-xs text-slate-500 mt-1">Progress</p>
        </div>
    </div>
    {% else %}
    <!-- Per-Project Breakdown -->
    <div class="card mb-6">
        <h3 class="text-sm font-semibold text-slate-900 mb-4"><i class="fas fa-chart-bar text-blue-600 mr-2"></i>Tasks by Project</h3>
        <div class="grid grid-cols-2 gap-3">
            {% for ps in project_stats %}
            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <a href="/project/{{ ps.id }}" class="font-medium text-slate-900 hover:text-blue-600">{{ ps.project_name }}</a>
                    <span class="badge badge-blue">{{ ps.domain }}</span>
                </div>
                <div class="flex items-center gap-4 text-sm">
                    <span class="text-green-600 font-medium">{{ ps.completed }}</span>
                    <span class="text-slate-400">/</span>
                    <span class="text-slate-600">{{ ps.total }}</span>
                    <div class="w-20">
                        <div class="progress-bar"><div class="progress-fill bg-blue-500" style="width: {{ (ps.completed / (ps.total or 1) * 100)|round }}%"></div></div>
                    </div>
                    <span class="font-bold text-slate-700 w-12 text-right">{{ ((ps.completed / (ps.total or 1)) * 100)|round|int }}%</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Global Stats (smaller) -->
    <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="card text-center py-3">
            <p class="text-lg font-bold text-slate-900">{{ stats.total or 0 }}</p>
            <p class="text-xs text-slate-500">Total (all projects)</p>
        </div>
        <div class="card text-center py-3">
            <p class="text-lg font-bold text-green-600">{{ stats.completed or 0 }}</p>
            <p class="text-xs text-slate-500">Completed</p>
        </div>
        <div class="card text-center py-3">
            <p class="text-lg font-bold text-blue-600">{{ stats.in_progress or 0 }}</p>
            <p class="text-xs text-slate-500">In Progress</p>
        </div>
        <div class="card text-center py-3">
            <p class="text-lg font-bold text-slate-400">{{ stats.pending or 0 }}</p>
            <p class="text-xs text-slate-500">Pending</p>
        </div>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="card mb-6">
        <form method="GET" action="/tasks" id="filterForm" class="space-y-4">
            <div class="flex items-center gap-4 flex-wrap">
                <!-- Project Filter -->
                <div>
                    <label class="text-xs font-medium text-slate-500 block mb-1">Project</label>
                    <select name="project_id" onchange="document.getElementById('filterForm').submit()"
                            class="border border-slate-300 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="0">All Projects</option>
                        {% for p in all_projects %}
                        <option value="{{ p.id }}" {% if filters.project_id == p.id %}selected{% endif %}>{{ p.project_name }} ({{ p.domain }})</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Phase Filter -->
                <div>
                    <label class="text-xs font-medium text-slate-500 block mb-1">Phase</label>
                    <select name="phase" onchange="document.getElementById('filterForm').submit()"
                            class="border border-slate-300 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="0">All Phases</option>
                        {% for i in range(1, 10) %}
                        <option value="{{ i }}" {% if filters.phase == i %}selected{% endif %}>Phase {{ i }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Status Filter Chips -->
                <div>
                    <label class="text-xs font-medium text-slate-500 block mb-1">Status</label>
                    <div class="flex gap-2">
                        <a href="/tasks?project_id={{ filters.project_id }}&phase={{ filters.phase }}&status=&ownership={{ filters.ownership }}" class="filter-chip {% if not filters.status %}active{% endif %}">All</a>
                        <a href="/tasks?project_id={{ filters.project_id }}&phase={{ filters.phase }}&status=pending&ownership={{ filters.ownership }}" class="filter-chip {% if filters.status == 'pending' %}active{% endif %}">Pending</a>
                        <a href="/tasks?project_id={{ filters.project_id }}&phase={{ filters.phase }}&status=in_progress&ownership={{ filters.ownership }}" class="filter-chip {% if filters.status == 'in_progress' %}active{% endif %}">Active</a>
                        <a href="/tasks?project_id={{ filters.project_id }}&phase={{ filters.phase }}&status=completed&ownership={{ filters.ownership }}" class="filter-chip {% if filters.status == 'completed' %}active{% endif %}">Done</a>
                    </div>
                </div>

                <!-- Ownership Filter -->
                <div>
                    <label class="text-xs font-medium text-slate-500 block mb-1">Ownership</label>
                    <div class="flex gap-2">
                        <a href="/tasks?project_id={{ filters.project_id }}&phase={{ filters.phase }}&status={{ filters.status }}&ownership=" class="filter-chip {% if not filters.ownership %}active{% endif %}">All</a>
                        <a href="/tasks?project_id={{ filters.project_id }}&phase={{ filters.phase }}&status={{ filters.status }}&ownership=Platform Team" class="filter-chip {% if filters.ownership == 'Platform Team' %}active{% endif %}">Platform</a>
                        <a href="/tasks?project_id={{ filters.project_id }}&phase={{ filters.phase }}&status={{ filters.status }}&ownership=App Team" class="filter-chip {% if filters.ownership == 'App Team' %}active{% endif %}">App Team</a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Results Count -->
    <div class="flex items-center justify-between mb-4">
        <p class="text-sm text-slate-500">Showing <span class="font-semibold text-slate-700">{{ tasks|length }}</span> tasks</p>
        <div class="flex items-center gap-2">
            <button onclick="toggleView('table')" id="btn-table" class="p-1.5 rounded text-slate-400 hover:text-slate-600 bg-slate-100"><i class="fas fa-table-list"></i></button>
            <button onclick="toggleView('cards')" id="btn-cards" class="p-1.5 rounded text-slate-400 hover:text-slate-600"><i class="fas fa-grip"></i></button>
        </div>
    </div>

    <!-- Table View -->
    <div id="view-table" class="card">
        <table class="w-full text-sm">
            <thead>
                <tr class="text-xs text-slate-500 uppercase tracking-wider border-b border-slate-200">
                    <th class="text-left py-3 font-medium">Task</th>
                    <th class="text-left py-3 font-medium">Project</th>
                    <th class="text-left py-3 font-medium">Phase</th>
                    <th class="text-left py-3 font-medium">Category</th>
                    <th class="text-left py-3 font-medium">Owner</th>
                    <th class="text-left py-3 font-medium">Priority</th>
                    <th class="text-left py-3 font-medium">Status</th>
                    <th class="text-right py-3 font-medium">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for t in tasks %}
                <tr class="task-card border-t border-slate-100">
                    <td class="py-3">
                        <div class="font-medium text-slate-900">{{ t.task_name }}</div>
                        <div class="text-xs text-slate-400 mt-0.5">{{ t.estimated_minutes }} min est.</div>
                    </td>
                    <td class="py-3">
                        <a href="/project/{{ t.project_id }}" class="text-blue-600 hover:text-blue-800 font-medium">{{ t.project_name }}</a>
                        <span class="badge badge-blue ml-1">{{ t.domain }}</span>
                    </td>
                    <td class="py-3 text-slate-600">P{{ t.phase_number }}</td>
                    <td class="py-3"><span class="badge badge-gray">{{ t.category }}</span></td>
                    <td class="py-3 text-slate-600">{{ t.ownership }}</td>
                    <td class="py-3">
                        {% if t.priority == 'critical' %}<span class="badge badge-red">Critical</span>
                        {% elif t.priority == 'high' %}<span class="badge badge-amber">High</span>
                        {% else %}<span class="badge badge-gray">{{ t.priority|capitalize }}</span>{% endif %}
                    </td>
                    <td class="py-3">
                        {% if t.status == 'completed' %}<span class="badge badge-green"><i class="fas fa-check mr-1"></i>Done</span>
                        {% elif t.status == 'in_progress' %}<span class="badge badge-blue"><i class="fas fa-spinner mr-1"></i>Active</span>
                        {% else %}<span class="badge badge-gray">Pending</span>{% endif %}
                    </td>
                    <td class="py-3 text-right">
                        {% if t.status == 'pending' %}
                        <button class="px-2.5 py-1 text-xs font-medium bg-blue-50 text-blue-700 rounded-md hover:bg-blue-100" onclick="updateTask({{ t.id }}, 'in_progress')">Start</button>
                        {% elif t.status == 'in_progress' %}
                        <button class="px-2.5 py-1 text-xs font-medium bg-green-50 text-green-700 rounded-md hover:bg-green-100" onclick="updateTask({{ t.id }}, 'completed')">Done</button>
                        {% else %}
                        <button class="px-2.5 py-1 text-xs font-medium bg-slate-50 text-slate-600 rounded-md hover:bg-slate-100" onclick="updateTask({{ t.id }}, 'pending')">Reset</button>
                        {% endif %}
                        <button class="px-2.5 py-1 text-xs font-medium bg-amber-50 text-amber-700 rounded-md hover:bg-amber-100 ml-1" onclick="editTask({{ t|tojson|e }})"><i class="fas fa-pencil"></i></button>
                        <button class="px-2.5 py-1 text-xs font-medium bg-red-50 text-red-700 rounded-md hover:bg-red-100 ml-1" onclick="deleteTask({{ t.id }}, '{{ t.task_name|e }}')"><i class="fas fa-trash"></i></button>
                        {% if t.actions_raw %}
                        {% for action in t.actions_raw.split(';;') %}
                        {% set parts = action.split('|') %}
                        <a href="{{ parts[1] }}" target="_blank" class="px-2.5 py-1 text-xs font-medium bg-purple-50 text-purple-700 rounded-md hover:bg-purple-100 ml-1">{{ parts[0] }}</a>
                        {% endfor %}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if not tasks %}
                <tr><td colspan="8" class="text-center py-12 text-slate-400"><i class="fas fa-inbox text-3xl mb-2 block"></i>No tasks match the current filters</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Card View (hidden by default) -->
    <div id="view-cards" class="hidden grid grid-cols-2 gap-4">
        {% for t in tasks %}
        <div class="card card-hover animate-in" style="animation-delay: {{ loop.index * 0.02 }}s">
            <div class="flex items-start justify-between">
                <div>
                    <h3 class="font-medium text-slate-900 text-sm">{{ t.task_name }}</h3>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="badge badge-blue">{{ t.domain }}</span>
                        <span class="badge badge-gray">P{{ t.phase_number }}</span>
                        <span class="badge badge-gray">{{ t.category }}</span>
                    </div>
                </div>
                {% if t.status == 'completed' %}<span class="badge badge-green">Done</span>
                {% elif t.status == 'in_progress' %}<span class="badge badge-blue">Active</span>
                {% else %}<span class="badge badge-gray">Pending</span>{% endif %}
            </div>
            <div class="flex items-center justify-between mt-3 pt-3 border-t border-slate-100 text-xs text-slate-500">
                <span>{{ t.ownership }} &middot; {{ t.estimated_minutes }} min</span>
                <div>
                    {% if t.status == 'pending' %}
                    <button class="px-2 py-1 bg-blue-50 text-blue-700 rounded font-medium hover:bg-blue-100" onclick="updateTask({{ t.id }}, 'in_progress')">Start</button>
                    {% elif t.status == 'in_progress' %}
                    <button class="px-2 py-1 bg-green-50 text-green-700 rounded font-medium hover:bg-green-100" onclick="updateTask({{ t.id }}, 'completed')">Done</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<!-- Edit Task Modal -->
<div class="modal-backdrop" id="editTaskModal">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-slate-900">Edit Task</h3>
            <button onclick="hideModal('editTaskModal')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
        </div>
        <form id="editTaskForm" onsubmit="submitEditTask(event)" class="space-y-4">
            <input type="hidden" name="task_id" id="editTaskId">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Task Name</label>
                <input type="text" name="task_name" id="editTaskName" required class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                    <input type="text" name="category" id="editTaskCat" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Ownership</label>
                    <select name="ownership" id="editTaskOwner" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="Platform Team">Platform Team</option>
                        <option value="App Team">App Team</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Priority</label>
                    <select name="priority" id="editTaskPri" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Est. Minutes</label>
                    <input type="number" name="estimated_minutes" id="editTaskEst" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="flex justify-end gap-3 pt-2">
                <button type="button" onclick="hideModal('editTaskModal')" class="px-4 py-2 text-sm text-slate-600 hover:text-slate-800">Cancel</button>
                <button type="submit" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleView(view) {
    document.getElementById('view-table').classList.toggle('hidden', view !== 'table');
    document.getElementById('view-cards').classList.toggle('hidden', view !== 'cards');
    document.getElementById('btn-table').classList.toggle('bg-slate-100', view === 'table');
    document.getElementById('btn-cards').classList.toggle('bg-slate-100', view === 'cards');
}

async function updateTask(taskId, status) {
    const resp = await fetch('/api/task/' + taskId + '/status', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: status})
    });
    if (resp.ok) location.reload();
}

function editTask(task) {
    document.getElementById('editTaskId').value = task.id;
    document.getElementById('editTaskName').value = task.task_name || '';
    document.getElementById('editTaskCat').value = task.category || '';
    document.getElementById('editTaskOwner').value = task.ownership || 'Platform Team';
    document.getElementById('editTaskPri').value = task.priority || 'medium';
    document.getElementById('editTaskEst').value = task.estimated_minutes || 30;
    showModal('editTaskModal');
}

async function submitEditTask(e) {
    e.preventDefault();
    const fd = new FormData(e.target);
    const taskId = fd.get('task_id');
    const body = {
        task_name: fd.get('task_name'),
        category: fd.get('category'),
        ownership: fd.get('ownership'),
        priority: fd.get('priority'),
        estimated_minutes: parseInt(fd.get('estimated_minutes')) || 30
    };
    const resp = await fetch('/api/task/' + taskId, {
        method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
    });
    if (resp.ok) {
        hideModal('editTaskModal');
        showToast('Task updated', 'success');
        location.reload();
    } else {
        showToast('Error updating task', 'error');
    }
}

async function deleteTask(taskId, taskName) {
    if (!confirm('Delete task "' + taskName + '"? This action cannot be undone.')) return;
    const resp = await fetch('/api/task/' + taskId, {method: 'DELETE'});
    if (resp.ok) {
        showToast('Task deleted', 'success');
        location.reload();
    } else {
        showToast('Error deleting task', 'error');
    }
}
</script>
{% endblock %}
